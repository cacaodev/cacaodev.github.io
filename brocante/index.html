<!DOCTYPE html>
<html>

<head>
    <title>Brocante Laumière</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="paperstyle.css">
    <link rel="stylesheet" href="assets/css/forms.css">
    <link rel="stylesheet" href="assets/css/font-awesome.css">
    <link rel="stylesheet" href="assets/css/mobile.css">
    <link rel="stylesheet" href="loader.css">
    <link rel="stylesheet" href="pan-zoom.css">
    <link rel="stylesheet" href="style.css">

    <script type="text/javascript" src="wheelPolyfill.js"></script>
    <script type="text/javascript" src="paper-full.js"></script>
    <script type="text/paperscript" canvas="canvas" src="paper_main.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script type="text/javascript" src="js-form-validator.js"></script>
    <script type="text/javascript" language="javascript">
        var HOST_URL = "https://www.lesamisducarrefour.org";
        //var HOST_URL = "http://trac.uk.to:8000";
        var GOOGLE_SCRIPT_URL_RESERVATIONS_EN_LIGNE = "https://script.google.com/macros/s/AKfycbyoS7HYII5GsPzI5GWsF_Nd7ZnUVKjjIaU4T2XA08trT9YjSAQ/exec";
        var GOOGLE_SCRIPT_URL_INSCRIPTIONS_SUR_PLACE = "https://script.google.com/macros/s/AKfycbxwqe4IjmI4PZlv03yEMrzlJ6Sr7pNYgdh5Odi1JmZTI_TThy69/exec";
        var TARIF_NORMAL = 20;
        var TARIF_REDUIT = 15;
        var selectedTabItemIndex = -1;
        var formvalidator = null;
        var id_transaction = null;
        var emplacements_vendus = [];
        var emplacements_choisis = [];
        var emplacementsParSecteur = {
            'A': [{
                start: 1001,
                end: 1022
            }, {
                start: 2001,
                end: 2008
            }],
            'B': [{
                    start: 1023,
                    end: 1046
                }, {
                    start: 2009,
                    end: 2028
                },
                {
                    start: 2030,
                    end: 2038
                }
            ],
            'C': [{
                start: 1047,
                end: 1087
            }, {
                start: 2039,
                end: 2062
            }],
            'D': [{
                start: 1088,
                end: 1110
            }, {
                start: 2063,
                end: 2095
            }],
            'E': [{
                start: 1111,
                end: 1121
            }]
        };

        function getSecteurForEmplacement(empl) {
            for (var secteur in emplacementsParSecteur) {
                var ranges = emplacementsParSecteur[secteur];
                for (var i = 0; i < ranges.length; i++) {
                    var r = ranges[i];
                    if (empl >= r.start && empl <= r.end)
                        return secteur;
                }
            }

            return null;
        }

        function toogleEditMode(button) {
            var mode = 1 - parseInt(button.value);
            setEditMode(mode);
            button.style.backgroundColor = (mode == 1) ? 'gray' : 'white';
            button.value = mode;
        }

        function setEditMode(flag) {
            globals._setEditMode(flag);
            document.getElementById('container').style.borderWidth = flag ? "2px" : "0px";
        }

        function MouseWheelHandler(e) {
            // cross-browser wheel delta

            var e = window.event || e; // old IE support
            e.preventDefault();

            zoomBy(-e.deltaY);
            return false;
        }

        function touchMove(e) {
            // cross-browser wheel delta
            var e = window.event || e; // old IE support
            e.preventDefault();

            moveBy(e.delta);
            return false;
        }

        function touchStart(e) {
            cosnole.log(e);
            return false;
        }

        function touchEnd(e) {
            cosnole.log(e);
            return false;
        }

        function moveBy(delta) {
            globals.moveBy(delta);
        }

        function zoomBy(delta) {
            globals.zoomBy(delta);
        }

        function zoomTo(level) {
            globals.setZoom(level);
        }

        function setCursor(cursor) {
            document.body.style.cursor = cursor;
        }

        if (!String.format) {
            String.format = function(format) {
                var args = Array.prototype.slice.call(arguments, 1);
                return format.replace(/{(\d+)}/g, function(match, number) {
                    return typeof args[number] != 'undefined' ?
                        args[number] :
                        match;
                });
            };
        }

        /**
         * Append a pre element to the body containing the given message
         * as its text node. Used to display the results of the API call.
         *
         * @param {string} message Text to be placed in pre element.
         */
        // function appendPre(message) {
        //     var pre = document.getElementById('content');
        //     var textContent = document.createTextNode(message + '\n');
        //     pre.appendChild(textContent);
        // }

        function handleClientLoad() {
            addWheelListener(document, MouseWheelHandler, false);
            document.body.addEventListener('touchstart', touchStart, false);
            document.body.addEventListener('touchmove', touchMove, false);
            document.body.addEventListener('touchend', touchEnd, false);

            loadProject(function() {
                setEditMode(false);
                gapi.load('client', getEmplacementsVendus);
            });
        }

        var getEmplacementsVendus = function() {

            var requestsCount = 2;

            sendRequest((GOOGLE_SCRIPT_URL_INSCRIPTIONS_SUR_PLACE + "?emplacements=1"), function(data, err) {
                var json = (err == null) ? JSON.parse(data) : {
                    "result": "error",
                    "error": err
                };

                if (json.result == "success") {
                    console.log("Emplacements vendus sur place:" + json.emplacements.length);
                    emplacements_vendus = emplacements_vendus.concat(json.emplacements);
                    updateEmplacementsVendus();
                    requestsCount--;
                    if (requestsCount == 0) {
                        didReceiveAllEmplacementsvendus();
                    }
                } else {
                    console.warn(json.error);
                    setDescription("");
                    setWarning(true, "Une erreur est survenue lors du chargement. Veuillez ré-essayer plus tard.");
                }
            });

            sendRequest((GOOGLE_SCRIPT_URL_RESERVATIONS_EN_LIGNE + "?getemplacements=1"), function(data, err) {
                var json = (err == null) ? JSON.parse(data) : {
                    "result": "error",
                    "error": err
                };

                if (json.result == "success") {
                    console.log("Emplacements vendus en ligne:" + json.emplacements.length);
                    emplacements_vendus = emplacements_vendus.concat(json.emplacements);
                    updateEmplacementsVendus();
                    requestsCount--;
                    if (requestsCount == 0) {
                        didReceiveAllEmplacementsvendus();
                    }
                } else {
                    console.warn(json.error);
                    setDescription("");
                    setWarning(true, "Une erreur est survenue lors du chargement. Veuillez ré-essayer plus tard.");
                }
            });
        };

        function didReceiveAllEmplacementsvendus() {
            clickNextTabItem();
            document.getElementsByClassName('lds-roller')[0].style.display = "none";
            document.getElementById('canvas').style.opacity = "1";
        }

        function updateEmplacementsVendus() {
            window.globals.setEmplacementsVendus(emplacements_vendus);
        }

        function emplacementsDisponiblesPourSecteur(secteur) {
            var result = [];
            var ranges = emplacementsParSecteur[secteur];
            ranges.forEach(function(r) {
                var list = arrayFromRangeExcludingNumbers(r, emplacements_vendus);
                result = result.concat(list);
            });

            return result;
        }

        function selectionDidChange(selection) {
            console.log("Selection " + selection);
            emplacements_choisis = selection;
            var metrage = emplacements_choisis.length * 2;
            var text;
            if (metrage > 0)
                text = String.format("<b>{1}</b> mètre{4} soit <b>{0}</b> emplacement{3} avec le{3} numéro{3}: <b>{2}</b>", emplacements_choisis.length, metrage, emplacements_choisis.join(", "), s(emplacements_choisis.length), s(metrage));
            else
                text = "Aucun emplacement sélectionné";

            setDescription(text);

            var contigus = isContigu(emplacements_choisis);
            setInstructions(contigus ? "Veuillez sélectionner un ou des emplacements libres en vert. Vous pouvez zoomer et déplacer le plan." : "");
            setWarning(!contigus, "⚠️ Les emplacements ne sont pas contigus");
            setPanier(metrage == 0 ? "" : "Total: " + metrage * TARIF_NORMAL + "€ (" + metrage * TARIF_REDUIT + "€ pour résidents)");

            updatetabItemsState();
        }

        function s(n) {
            return (n > 1) ? "s" : "";
        }

        function updatetabItemsState() {
            var tab_items = ['choix_emplacements', 'infos_exposant', 'paiement'];
            var nextTabID = tab_items[selectedTabItemIndex + 1];
            var shouldSelect = shouldSelectTabItem(nextTabID);

            var el = document.getElementById('suivant');
            enable(el, shouldSelect);
        }

        function setPanier(text) {
            document.getElementById("panier").innerHTML = text;
        }

        function setDescription(text) {
            document.getElementById("description-emplacements").innerHTML = text;
        }

        function setInstructions(text) {
            document.getElementById("emplacements-instructions").innerHTML = text;
        }
        function setWarning(onOff, text) {
            document.getElementById('emplacements-warning').innerHTML = onOff ? text : "";
            document.getElementById('bandeau-description').style.backgroundColor = onOff ? "lightyellow" : "white";
        }

        function getFormValidator(onAir, showErrors) {
            if (formvalidator == null) {
                // Init validator with standart settings
                formvalidator = new Validator(document.getElementById('infos'), function(err, res) {
                    return true;
                }, {
                    "locale": "en",
                    "onAir": onAir,
                    "showErrors": showErrors
                });
            }

            return formvalidator;
        }

        function eraseFormValidator() {
            //formvalidator.destroy();
            formvalidator = null;
        }

        function clickNextTabItem() {
            var tab_items = ['choix_emplacements', 'infos_exposant', 'paiement'];
            var tabID = tab_items[selectedTabItemIndex + 1];
            console.log("clickNextTabItem " + (selectedTabItemIndex + 1));
            didClickTabItem(tabID);
        }

        function shouldSelectTabItem(tabItemValue) {
            if (tabItemValue == "paiement") {
                var validation_result = getFormValidator(false, false).validate();

                console.log('Validation= ' + validation_result);

                if (validation_result !== true) {
                    //eraseFormValidator();
                    getFormValidator(true, true).showErrors();

                    return false;
                }
            }
console.log('shouldSelectTabItem' + tabItemValue + " emplacements_choisis " + emplacements_choisis);
            if (tabItemValue !== 'choix_emplacements' && emplacements_choisis.length == 0)
                return false;

            return true;
        }

        function updateTabItemsVisibility(tabItemValue) {
            var tabViews = document.getElementsByClassName("active");

            for (var i = 0; i < tabViews.length; i++) {
                tabViews[i].className = "inactive";
            }

            var tabItems = document.getElementsByClassName("selected");
            for (var i = 0; i < tabItems.length; i++) {
                var tabItem = tabItems[i];
                tabItem.className = "deselected";
            }

            document.getElementById("item-" + tabItemValue).className = "selected";
            document.getElementById(tabItemValue).className = "active";
        }

        function tabItemDidAppear(tabItemValue) {
            updatetabItemsState();

            if (tabItemValue == "paiement") {

                var elements = document.forms.infos.elements; // Ou document.forms['login']

                var params = {};
                for (var i = 0; i < elements.length; i++) {
                    var item = elements.item(i);
                    params[item.name] = item.value || "";
                }

                var secteurs = [];
                for (var i = 0; i < emplacements_choisis.length; i++) {
                    var e = emplacements_choisis[i];
                    var s = getSecteurForEmplacement(e);
                    if (secteurs.indexOf(s) == -1)
                        secteurs.push(s);
                }

                var prix_metre = (params['Code Postal'] == '75019') ? TARIF_REDUIT : TARIF_NORMAL;

                params["Emplacements"] = emplacements_choisis.join("-");
                params["Secteurs"] = secteurs.join("-");
                params["Payé"] = "EN ATTENTE";

                var esc = encodeURIComponent;
                var query = Object.keys(params).map(function(k){ return esc(k) + "=" + esc(params[k]); }).join('&');

                if (id_transaction !== null)
                    query += "&uuid=" + id_transaction;

                sendRequest((GOOGLE_SCRIPT_URL_RESERVATIONS_EN_LIGNE + "?creation=1&" + query), function(data, err) {
                    if (err !== null) {
                        console.log(`Network Error:${err}`);
                    } else {
                        var json = JSON.parse(data);

                        if (json.result == "success") {
                            id_transaction = json.uuid;
                            console.log(`uuid: ${id_transaction} row:${json.row}`);

                            var form = document.forms.paypal;
                            form.elements.invoice.value = json.row;
                            form.elements.os1.value = json.row;
                            form.elements.quantity.value = emplacements_choisis.length * 2;
                            form.elements.amount.value = prix_metre;
                            form.elements.return.value = HOST_URL + "/_functions/paypal/validation?uuid=" + id_transaction;
                            form.elements.cancel_return.value = HOST_URL + "/_functions/paypal/annulation?uuid=" + id_transaction;
                        } else if (json.result == "error") {
                            console.log(`Script Error:${json.error.message}`);
                        }
                    }
                });

                var template =
                    "\
Vide-grenier Laumière du Dimanche 07 Avril 2019.\n\n\
   Nombre d'emplacements: <b>{0}</b>\n\
Numeros des emplacements: <b>{1}</b>\n\
              Secteur{3}: <b>{2}</b>\n\
                    Prix: <b>{4} €</b>";

                var el = document.getElementById("paypal_header");
                var text = String.format(template, emplacements_choisis.length, emplacements_choisis, secteurs, (secteurs.length > 1) ? "s" : "", emplacements_choisis.length * 2 * prix_metre);
                el.innerHTML = text;
            }
        }

        function didClickTabItem(tabItemValue) {
            console.log('didClickTabItem ' + tabItemValue);

            if (!shouldSelectTabItem(tabItemValue))
                return;

            selectedTabItemIndex = ['choix_emplacements', 'infos_exposant', 'paiement'].indexOf(tabItemValue);

            updateTabItemsVisibility(tabItemValue);
            tabItemDidAppear(tabItemValue);
        }

        function enable(el, flag) {
            var cl = el.classList;

            if (flag)  {
                cl.replace('disabled', 'enabled');
            }
            else {
                cl.replace('enabled', 'disabled');
            }

            console.log(el.id + " =" + el.className);
        }

        function downloadProject() {
            var json_export = window.globals.exportJSON();
            var a = window.document.createElement('a');
            a.href = window.URL.createObjectURL(new Blob([json_export], {
                type: 'text/plain'
            }));
            a.download = 'project.json';

            // Append anchor to body.
            document.body.appendChild(a);
            a.click();

            // Remove anchor from body
            document.body.removeChild(a);
        }

        function loadProject(callback) {
            sendRequest("project.json", function(data, err) {
                console.log("loaded file project.json");
                if (err == null)
                    window.globals.importJSON(data);
                else
                    console.warn(err);

                callback();
            });
        }

        function isContigu(a) {
            return a.length == 0 || Math.max.apply(null, a) - Math.min.apply(null, a) == a.length - 1;
        }

        function sendRequest(file, callback) {
            var xhr = new XMLHttpRequest();

            // On souhaite juste récupérer le contenu du fichier, la méthode GET suffit amplement :
            xhr.open('GET', file);

            xhr.addEventListener('readystatechange', function() { // On gère ici une requête asynchrone

                if (xhr.readyState === XMLHttpRequest.DONE) { // Si le fichier est chargé sans erreur
                    if (xhr.status === 200)
                        callback(xhr.responseText, null);
                    else {
                        callback(null, "Error " + xhr.status);
                    }
                }
            });

            xhr.send(null); // La requête est prête, on envoie tout !
        }
    </script>

</head>

<body onload="handleClientLoad()">
    <!-- <pre id="content" style="white-space: pre-wrap;"></pre> -->

    <div id="logos" class="desktop">
        <span id="event_desc" class="desktop">VIDE-GRENIER AVENUE DE LAUMIÈRE LE 7 AVRIL 2019</span>
    </div>

    <div id="tabsbar" class="desktop">
        <button type="button" id="item-choix_emplacements" class="selected" value="choix_emplacements" onclick="didClickTabItem(this.value)">① Emplacements</button>
        <button type="button" id="item-infos_exposant" class="deselected" value="infos_exposant" onclick="didClickTabItem(this.value)">⓶ Informations</button>
        <button type="button" id="item-paiement" value="paiement" class="deselected" onclick="didClickTabItem(this.value)">⓷ Paiement</button>
    </div>

    <div id="suivant_wrapper" class="disabled desktop">
        <button id="suivant" class="disabled desktop" value="0" type="button" onclick="clickNextTabItem()">Valider</button>
    </div>

    <div class="active" id="choix_emplacements">
        <div id="description-emplacements" class="desktop">Aucun emplacement sélectionné</div>
        <div id="bandeau-description" class="bandeau desktop">
            <button id="editmode" type="button" onclick="toogleEditMode(this)" value="1">EditMode</button>
            <button id="update" type="button" onclick="updateEmplacementsVendus()">Update</button>
            <button id="download" type="button" onclick="downloadProject()">Download</button>

            <div id="emplacements-instructions" class="bandeau_infos desktop">
                Veuillez sélectionner un ou des emplacements libres en vert. Vous pouvez zoomer et déplacer le plan.
            </div>
            <div id="emplacements-warning" class="bandeau_warning desktop"></div>
            <div id="panier" class="bandeau_infos_right desktop"></div>
        </div>

        <div id="container">
            <div class="lds-roller">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div id="controls">
                <div class="btn-group-vertical desktop" role="group" aria-label="..." id="float-button-group">
                    <button onclick="zoomBy(10)" type="button" class="btn btn-default" id="zoom-in">🔍<span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button>
                    <button onclick="zoomBy(-10)" type="button" class="btn btn-default" id="zoom-out">🔍<span class="glyphicon glyphicon-zoom-out" aria-hidden="true"></span></button>
                    <button type="button" class="btn btn-default" id="reset">🌐<span class="glyphicon glyphicon-screenshot" aria-hidden="true"></span></button>
                </div>
                <input oninput="zoomTo(this.value)" type="range" value="0.25" min="0.1" max="3" step="0.25" orient="vertical" id="map-zoomer" />
            </div>

            <canvas id="canvas" resize style="background-color:white"></canvas>
        </div>
    </div>

    <div class="inactive desktop" id="infos_exposant">
        <div id="instructions_exposants" class="bandeau">
            <div id="instructions" class="bandeau_warning">Important: le jour du vide-grenier, merci de venir avec une photocopie de la pièce d'identité de la personne inscrite (recto-verso).</div>
        </div>

        <form id="infos" name="infos" onsubmit="">
            <input onchange="updatetabItemsState();" type="text" id="nom" name="Nom" data-rule="required|lastname" placeholder="Nom" autocomplete="family-name" />
            <input onchange="updatetabItemsState();" type="text" id="prenom" name="Prénom" data-rule="required|name" placeholder="Prénom" autocomplete="given-name" />
            <input onchange="updatetabItemsState();" type="text" id="adresse" name="Adresse" data-rule="required" placeholder="Adresse" autocomplete="street-address" />
            <input onchange="updatetabItemsState();" type="text" id="codepostal" name="Code Postal" data-rule="required|minlength-5|maxlenght-5" placeholder="Code Postal" autocomplete="postal-code" />
            <input onchange="updatetabItemsState();" type="text" id="email" name="Email" data-rule="required|email" placeholder="Email" autocomplete="email" />
            <input onchange="updatetabItemsState();" type="text" id="telephone" name="Téléphone" data-rule="required|phone" placeholder="Téléphone" autocomplete="tel" />
            <label>Véhicule:</label>
            <input type="radio" id="voiture" name="Véhicule" value="voiture" />
            <label for="voiture">Voiture</label>
            <input type="radio" id="utilitaire" name="Véhicule" value="utilitaire" />
            <label for="utilitaire">Utilitaire</label>
            <input type="radio" id="camionette" name="Véhicule" value="camionette" />
            <label for="camionette">Camionnette</label>
            <input type="radio" id="aucun" name="Véhicule" value="aucun" />
            <label for="aucun">Aucun</label>
            <input type="text" id="immat" name="Immatriculation" data-rule="" placeholder="Immatriculation" />
        </form>
        <!-- Append the validator JS script -->
    </div>

    <div class="inactive desktop" id="paiement">
        <div class="header" id="paypal_header">
        </div>
        <div class="paypal-box">
            <!-- Start of Form -->
            <form name="paypal" method="post" id="paypal" action="https://www.paypal.com/cgi-bin/webscr">
                <!-- If using a Business or Company Logo Graphic, include the "cpp_header_image" variable. -->
                <input type="hidden" name="cpp_header_image" value="https://www.yourwebsite.com/logo.jpg">
                <!-- <input type="hidden" name="on0" value="Customer Number">
                <input type="hidden" name="os0" value="999"> -->
                <input type="hidden" name="on1" value="Invoice Number">
                <input type="hidden" name="os1" value="000">
                <input type="hidden" name="invoice">
                <input type="hidden" name="quantity">
                <input type="hidden" name="amount">
                <input id="paypal_button" type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_paynowCC_LG.gif" border="0" name="submit" alt="Make payments with PayPal - it's fast, free and secure!">
                <img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1">
                <input type="hidden" name="cmd" value="_xclick">
                <!-- Replace "business" value with your PayPal Email Address or your Merchant Account ID -->
                <input type="hidden" name="business" value="brocante-laumiere@orange.fr">
                <input type="hidden" name="item_name" value="Metres de stand">
                <input type="hidden" name="item_number" value="LAU-2019">

                <input type="hidden" name="no_shipping" value="1">
                <input type="hidden" name="tax" value="0.00">
                <!-- Replace value with the web page you want the customer to return to after a successful transaction -->
                <input type="hidden" name="return" value="https://www.lesamisducarrefour.org">
                <input type="hidden" value="2" name="rm">
                <!-- Replace value with the web page you want the customer to return to after item cancellation -->
                <input type="hidden" name="cancel_return" value="https://www.lesamisducarrefour.org">
                <input type="hidden" name="button_subtype" value="services">
                <input type="hidden" name="country" value="FR">
                <input type="hidden" name="currency_code" value="EUR">
                <input type="hidden" name="lc" value="FR">
                <input type="hidden" name="bn" value="PP-BuyNowBF:btn_paynowCC_LG.gif:NonHosted">
                <input type="hidden" name="no_note" value="0">
                <input type="hidden" name="cn" value="Ajouter des instructions pour le vendeur:">
            </form>
            <!-- End of Form -->
        </div>
        <div class="footer">
            En cliquant sur <b><i>Acheter</i></b>, vous serez redirigé vers le site Paypal sécurisé où vous pourrez payer par compte Paypal ou Carte Bleue.
        </div>
    </div>

    <div id="mentions" class="desktop">
        Association Les Amis du Carrefour des Solidarités - 145 rue de Crimée 75019 - ☎︎ 01 53 72 00 80 📱 06 63 75 69 05 📧 brocante-laumiere@orange.fr
    </div>

</body>

</html>
