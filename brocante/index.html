<!DOCTYPE html>
<html>

<head>
    <title>Brocante Laumière</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="paperstyle.css">
    <link rel="stylesheet" href="style.css">

    <script type="text/javascript" src="wheelPolyfill.js"></script>
    <script type="text/javascript" src="paper-full.js"></script>
    <script type="text/paperscript" canvas="canvas" src="paper_main.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>

<script type="text/javascript">
    function toogleEditMode(button) {
        var mode = 1 - parseInt(button.value);
        setEditMode(mode);
        button.style.backgroundColor = (mode == 1) ? 'gray' : 'white';
        button.value = mode;
    }

    function setEditMode(flag) {
        globals._setEditMode(flag);
        document.getElementById('container').style.borderWidth = flag ? "2px" : "0px";
    }

    function handleClientLoad() {
        initScroll();

        loadProject(function() {
            setEditMode(false);
            gapi.load('client', getEmplacementsVendus);
        });
    }

    function MouseWheelHandler(e)
    {
        // cross-browser wheel delta
        var e = window.event || e; // old IE support
        globals.mouseScrollBy(e);
        return false;
    }

    function initScroll() {
        addWheelListener(document, MouseWheelHandler, false);
    }

    function setCursor(cursor) {
        document.body.style.cursor = cursor;
    }

    var emplacements_vendus = [];
    var emplacements_choisis = [];

    var emplacementsParSecteur = {
        'A': [{
            start: 1001,
            end: 1022
        }, {
            start: 2001,
            end: 2008
        }],
        'B': [{
            start: 1023,
            end: 1046
        }, {
            start: 2009,
            end: 2028
        },
        {
            start: 2030,
            end: 2038
        }],
        'C': [{
            start: 1047,
            end: 1087
        }, {
            start: 2039,
            end: 2062
        }],
        'D': [{
            start: 1088,
            end: 1110
        }, {
            start: 2063,
            end: 2095
        }],
        'E': [{
            start: 1111,
            end: 1121
        }]
    }

    if (!String.format) {
        String.format = function(format) {
            var args = Array.prototype.slice.call(arguments, 1);
            return format.replace(/{(\d+)}/g, function(match, number) {
                return typeof args[number] != 'undefined'
                    ? args[number]
                    : match;
            });
        };
    }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message) {
        var pre = document.getElementById('content');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
    }
/*
    function arrayFromRangeExcludingNumbers(range, numbers) {
        var result = [];

        for (var i = range.start; i <= range.end; i++) {
            if (numbers.indexOf(i) == -1)
                result.push(i);
        }

        return result;
    }
*/
    var getEmplacementsVendus = function () {
      // 2. Initialize the JavaScript client library.
      gapi.client.init({
        'apiKey': 'AIzaSyCRrsNOnl754aQkNE_c0SKcc3WAMRyV7co',
        'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest']
      }).then(function() {
        // 3. Initialize and make the API request.
        return gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: '1VSLeyuwkhQN7n2AK9oHWdBahP6rHCJR_l1gNV2lVwHA',
            range: 'Form responses 1!Q2:R250',
        });

      }).then(function(response) {
          var result = [];
          var range = response.result;

              for (i = 0; i < range.values.length; i++) {
                  var row = range.values[i];
                  var debut = parseInt(row[0]),
                      fin = parseInt(row[1]);

                  if (typeof debut !== 'undefined') {
                      if (typeof fin == 'undefined')
                          fin = debut;

                      for (var e = debut; e <= fin; ++e) {
                          result.push(e);
                      }
                  }
              }

              emplacements_vendus = result;
              updateEmplacementsVendus(emplacements_vendus);

              appendPre('Emplacements mis à jour.');
            }, function(reason) {
               appendPre('Error: ' + reason.toString());
               console.log(reason);
      });
    };

    function updateEmplacementsVendus(arr) {
        window.globals.setEmplacementsVendus(arr);
    }

    function emplacementsDisponiblesPourSecteur(secteur) {
        var result = [];
        var ranges = emplacementsParSecteur[secteur];
        ranges.forEach(function(r) {
            var list = arrayFromRangeExcludingNumbers(r, emplacements_vendus);
            result = result.concat(list);
        });

        return result;
    }

    function selectionDidChange(selection) {
        console.log("Selection " + selection);
        emplacements_choisis = selection;
        var text = String.format("<b>Nombre d'emplacements</b>: {0} <b>Numéros</b>:{1}", emplacements_choisis.length, emplacements_choisis);

        setDescription(text);
    }

    function setDescription(text) {
        document.getElementById("description-emplacements").innerHTML = text;
    }

    function didClickTabItem(tabItemValue) {

        if (tabItemValue !== 'choix_emplacements' && emplacements_choisis.length == 0)
            return;

        var tabViews = document.getElementsByClassName("active");
        for (var i = 0; i < tabViews.length; i++) {
            tabViews[i].className = "inactive";
        }

        var tabItems = document.getElementsByClassName("selected");
        for (var i = 0; i < tabItems.length; i++) {
            var tabItem = tabItems[i];
            tabItem.className = "deselected";
        }

        document.getElementById("item-" + tabItemValue).className = "selected";
        document.getElementById(tabItemValue).className = "active";

        if (tabItemValue == "paiement") {
            var form = document.getElementById("paypal");

            //form.elements.invoice = params.invoice;
            //form.elements.on1 = params.invoice;
            //form.elements.os1 = params.invoice;
            //form.elements.quantity.value = emplacements_choisis.length * 2;
            //form.elements.amount = (40 * emplacements_choisis.length);

            var template =
                "\
Vide-grenier Laumière du Dimanche 07 Avril 2019.\n\
<b>   Nombre d'emplacements</b>: {0}\n\
<b>Numeros des emplacements</b>: {1}\n\
\n\
En cliquant sur <b><i>Acheter</i></b>, vous serez redirigé vers le site Paypal sécurisé où vous pourrez payer par compte Paypal ou Carte Bleue.";

            var el = document.getElementById("paypal_header");
            var text = String.format(template, emplacements_choisis.length, emplacements_choisis);

            el.innerHTML = text;
        }
    }

    function downloadProject() {
        var json_export = window.globals.exportJSON();
        var a = window.document.createElement('a');
        a.href = window.URL.createObjectURL(new Blob([json_export], {type: 'text/plain'}));
        a.download = 'project.json';

        // Append anchor to body.
        document.body.appendChild(a);
        a.click();

        // Remove anchor from body
        document.body.removeChild(a);
    }

    function loadProject(callback) {
        loadFile("project.json", function(data, err) {
        console.log("loaded file project.json");
            if (err == null)
                window.globals.importJSON(data);
            else
                console.warn(err);

            callback();
        });
    }

    function loadFile(file, callback) {

        var xhr = new XMLHttpRequest();

        // On souhaite juste récupérer le contenu du fichier, la méthode GET suffit amplement :
        xhr.open('GET', file);

        xhr.addEventListener('readystatechange', function() { // On gère ici une requête asynchrone

            if (xhr.readyState === XMLHttpRequest.DONE) { // Si le fichier est chargé sans erreur
                if (xhr.status === 200)
                    callback(xhr.responseText, null);
                else {
                    callback(null, "Impossible de charger le projet");
                }
            }
        });

        xhr.send(null); // La requête est prête, on envoie tout !
    }

</script>

</head>

<body onload="handleClientLoad()">
    <button id="authorize_button" style="display: none;">Authorize</button>
    <button id="signout_button" style="display: none;">Sign Out</button>
    <pre id="content" style="white-space: pre-wrap;"></pre>

    <div id="tabsbar">
        <button id="item-choix_emplacements" class="selected" value="choix_emplacements" onclick="didClickTabItem(this.value)">① Emplacements</button>
        <button id="item-infos_exposant" class="deselected" value="infos_exposant" onclick="didClickTabItem(this.value)">⓶ Informations</button>
        <button id="item-paiement" value="paiement" class="deselected" onclick="didClickTabItem(this.value)">⓷ Paiement</button>
    </div>

    <div class="active" id="choix_emplacements">
        <div id="description-emplacements">Nombre d'emplacements:0 Numéros:N/A</div>
        <div id="selection-emplacements">
            <button id="editmode" onclick="toogleEditMode(this)" value="1">EditMode</button>
            <button id="update" onclick="updateEmplacementsVendus()">Update</button>
            <button id="download" onclick="downloadProject()">Download</button>
            <button id="suivant" onclick="didClickTabItem('infos_exposant')">Suivant</button>
        </div>

        <div id="container">
            <canvas id="canvas" resize style="background-color:white"></canvas>
        </div>
    </div>

    <div class="inactive" id="infos_exposant">
        <form id="form">
            <label for="nom">Nom     :</label>
            <input type="text" id="nom" placeholder="Nom" />
            <label for="prenom">Prénom:</label>
            <input type="text" id="prenom" placeholder="Prénom" />
            </br><label for="adresse">Adresse :</label>
            <input type="text" id="adresse" placeholder="Adresse" />
            <label for="codepostal">Code Postal:</label>
            <input type="text" id="codepostal" placeholder="Code Postal" />
            </br><label for="email">Email   :</label>
            <input type="email" id="email" placeholder="Email" />
            <label for="telephone">Téléphone:</label>
            <input type="text" id="telephone" placeholder="Téléphone" pattern="\d{10}"/>
            </br><label for="vehicule">Véhicule:</label>
            <input type="text" id="vehicule" placeholder="Véhicule" />
            <label for="immat">Immatriculation:</label>
            <input type="text" id="immat" placeholder="Immatriculation" />
        </form>
        <button id="suivant" onclick="didClickTabItem('paiement')">Suivant</button>
    </div>

    <div class="inactive" id="paiement">
        <div class="header" id="paypal_header">
        </div>
        <div class="paypal-box">
            <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
                <input type="hidden" name="cmd" value="_s-xclick">
                <input type="hidden" name="hosted_button_id" value="L7ZC7LRFQHY6A">
                <input type="image" src="https://www.paypalobjects.com/fr_FR/FR/i/btn/btn_buynowCC_LG.gif" border="0" name="submit" alt="PayPal, le réflexe sécurité pour payer en ligne">
                <img alt="" border="0" src="https://www.paypalobjects.com/fr_FR/i/scr/pixel.gif" width="1" height="1">
            </form>
        </div>
        <div class="footer">
            Paiement sécurisé par Paypal.
        </div>
    </div>

</body>

</html>
